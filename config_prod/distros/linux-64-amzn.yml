linux-64-amzn-tmpl: &linux-64-amzn-tmpl
  template: true
  arch: linux_amd64
  provider: ec2
  ami: ami-d092a5b8
  user: ec2-user
  key: mci
  settings:
    ami: ami-d092a5b8
    instancetype: m3.2xlarge
    securitygroups: mci
    keyname: mci
    mountinfo: [
        {devicename: "/dev/xvdd", virtualname: "ephemeral0"}, #on m3.2xlarge, this is a 80GB SSD.
        {devicename: "/dev/xvde", virtualname: "ephemeral1"}, #on m3.2xlarge, this is a 80GB SSD.
    ]
  userdata: | 
    # see http://aws.amazon.com/amazon-linux-ami/faqs/#lock
    # cloud-config
    repo_releasever: 2013.03
  setup_as_sudo: true
  expansions: 
    decompress: tar zxvf
    ps: ps aux
    kill_pid: kill -- -$(ps opgid= %v)
  setup_mci_only: |
    echo "github.com,207.97.227.239 ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==" | tee -a /home/ec2-user/.ssh/known_hosts
    echo "${github_private_key}" | tee -a /home/ec2-user/.ssh/id_rsa
    echo "${github_public_key}" | tee -a /home/ec2-user/.ssh/id_rsa.pub
    echo "s3_key: ${s3_key}" | tee -a /data/expansions_s3.yml
    echo "s3_secret: ${s3_secret}" | tee -a /data/expansions_s3.yml
    echo "${api_httpscert}" | tee -a ${api_httpscert_path}
    chmod 600 /home/ec2-user/.ssh/*
    chown -R ec2-user:ec2-user /data
    chown -R ec2-user:ec2-user /home/ec2-user/.ssh

linux-64-amzn-build:
  <<: *linux-64-amzn-tmpl
  name: linux-64-amzn-build
  template: false
  spawn_allowed: false
  maxhosts: 5
  provider: ec2
  settings:
    ami: ami-d092a5b8
    bid_price: 0.56
    instancetype: m3.2xlarge
    securitygroups: mci
    keyname: mci
    mountinfo: [
        {devicename: "/dev/xvdd", virtualname: "ephemeral0"}, #on m3.2xlarge, this is a 80GB SSD.
        {devicename: "/dev/xvde", virtualname: "ephemeral1"}, #on m3.2xlarge, this is a 80GB SSD.
    ]
  setup: |
    #!/bin/bash
    set -o errexit
    set -o verbose

    umount /dev/xvdd || true
    umount /dev/xvde || true
    yes | mdadm --create /dev/md0 --level=0 -c256 --raid-devices=2 /dev/xvdd /dev/xvde
    blockdev --setra 32 /dev/md0
    /sbin/mkfs.xfs -f /dev/md0
    mkdir -p /data
    echo "/dev/md0 /data auto noatime 0 0" | tee -a /etc/fstab
    mount /data

    chown -R ec2-user:ec2-user /data

linux-64-amzn-test: &linux-64-amzn-test
  <<: *linux-64-amzn-tmpl
  name: linux-64-amzn-test
  template: false
  spawn_allowed: false
  maxhosts: 20
  provider: ec2-spot
  settings:
    ami: ami-d092a5b8
    instancetype: m3.xlarge
    bid_price: 0.14
    securitygroups: mci
    keyname: mci
    mountinfo: [
        {devicename: "/dev/xvdb", virtualname: "ephemeral0"}, #32GB for m3.large
    ]
  setup: |
    #!/bin/bash
    set -o errexit
    set -o verbose

    umount /dev/xvdb || true
    /sbin/mkfs.xfs -f /dev/xvdb
    echo "/dev/xvdb /data auto noatime 0 0" | tee -a /etc/fstab
    mkdir -p /data
    mount /dev/xvdb /data -t xfs
    chown -R ec2-user:ec2-user /data

linux-64-amzn-spawn:
  <<: *linux-64-amzn-test
  name: linux-64-amzn-spawn
  spawn_allowed: true
  provider: ec2
